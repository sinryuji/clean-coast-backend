"""
데이터베이스 초기화 스크립트

이 스크립트를 실행하면:
1. 데이터베이스 테이블을 생성합니다
2. 초기 관리자 계정을 생성합니다
3. 제주도 해변 정보를 생성합니다
"""
import sys
from core.database import init_db, SessionLocal
from models.user import User
from models.beach import Beach
from models.beach_prediction import BeachPrediction
from models.coastal_visitor_stats import CoastalVisitorStats
from passlib.context import CryptContext

# bcrypt 설정 (rounds를 12로 설정하여 안전성 확보)
pwd_context = CryptContext(
    schemes=["bcrypt"],
    deprecated="auto",
    bcrypt__rounds=12
)


def create_initial_users():
    """초기 사용자 생성"""
    db = SessionLocal()
    
    try:
        # 테이블 생성
        print("데이터베이스 테이블 생성 중...")
        init_db()
        print("테이블 생성 완료!")
        
        # admin 계정이 없으면 생성
        admin_user = db.query(User).filter(User.username == "admin").first()
        if not admin_user:
            print("관리자 계정 생성 중...")
            
            # 비밀번호 해싱 시도
            try:
                hashed_password = pwd_context.hash("admin123")
                admin = User(
                    username="admin",
                    password=hashed_password,
                    email="admin@example.com"
                )
                db.add(admin)
                db.commit()
                print("관리자 계정 생성 완료! (username: admin, password: admin123)")
            except Exception as hash_error:
                print(f"비밀번호 해싱 오류: {hash_error}")
                print("bcrypt 라이브러리를 재설치해주세요:")
                print("  pip uninstall bcrypt passlib")
                print("  pip install bcrypt==4.0.1 passlib==1.7.4")
                raise
        else:
            print("관리자 계정이 이미 존재합니다.")
        
        # test 계정 생성
        test_user = db.query(User).filter(User.username == "test").first()
        if not test_user:
            print("테스트 계정 생성 중...")
            try:
                hashed_password = pwd_context.hash("test123")
                test = User(
                    username="test",
                    password=hashed_password,
                    email="test@example.com"
                )
                db.add(test)
                db.commit()
                print("테스트 계정 생성 완료! (username: test, password: test123)")
            except Exception as hash_error:
                print(f"비밀번호 해싱 오류: {hash_error}")
                raise
        else:
            print("테스트 계정이 이미 존재합니다.")
        
        # 해변 데이터 생성
        print("\n제주도 해변 데이터 확인 중...")
        beaches_data = [
            {"name": "애월해안", "latitude": 33.46129, "longitude": 126.29343, "description": "애월해안(곽지과물해변)"},
            {"name": "조천해안", "latitude": 33.54323, "longitude": 126.66986, "description": "조천해안(함덕해수욕장)"},
            {"name": "예래해안", "latitude": 33.22843, "longitude": 126.47737, "description": "예래해안(강정크루즈터미널)"},
            {"name": "한림해안", "latitude": 33.39511, "longitude": 126.24028, "description": "한림해안(협재해수욕장)"},
            {"name": "성산해안", "latitude": 33.47330, "longitude": 126.93454, "description": "성산해안(성산항)"},
            {"name": "중문해안", "latitude": 33.24421, "longitude": 126.41406, "description": "중문해안(중문색달해수욕장)"},
            {"name": "구좌해안", "latitude": 33.55565, "longitude": 126.79566, "description": "구좌해안(월정리해변)"},
            {"name": "표선해안", "latitude": 33.32585, "longitude": 126.84252, "description": "표선해안(표선해비치해변)"},
            {"name": "남원해안", "latitude": 33.27262, "longitude": 126.66034, "description": "남원해안(위미항)"},
        ]
        
        existing_beaches = db.query(Beach).count()
        if existing_beaches == 0:
            print("해변 데이터 생성 중...")
            for beach_data in beaches_data:
                beach = Beach(**beach_data)
                db.add(beach)
            db.commit()
            print(f"{len(beaches_data)}개 해변 데이터 생성 완료!")
        else:
            print(f"해변 데이터가 이미 존재합니다. (총 {existing_beaches}개)")
        
        print("\n해안 방문객 통계 데이터 확인 중...")
        coastal_stats_data = [
            # 애월해안
            ('애월해안','2024-01',1131444),('애월해안','2024-02',973710),('애월해안','2024-03',881463),
            ('애월해안','2024-04',978662),('애월해안','2024-05',1008858),('애월해안','2024-06',1185911),
            ('애월해안','2024-07',1415125),('애월해안','2024-08',1649669),('애월해안','2024-09',1069690),
            ('애월해안','2024-10',1068021),('애월해안','2024-11',902593),('애월해안','2024-12',908716),
            ('애월해안','2025-01',994994),('애월해안','2025-02',875487),('애월해안','2025-03',797065),
            ('애월해안','2025-04',926883),('애월해안','2025-05',1028371),('애월해안','2025-06',1129107),
            ('애월해안','2025-07',1427859),('애월해안','2025-08',1678016),('애월해안','2025-09',1094457),
            ('애월해안','2025-10',1272433),
            # 조천해안
            ('조천해안','2024-01',1112874),('조천해안','2024-02',1009199),('조천해안','2024-03',1072009),
            ('조천해안','2024-04',1161439),('조천해안','2024-05',1246657),('조천해안','2024-06',1243603),
            ('조천해안','2024-07',1428509),('조천해안','2024-08',1636257),('조천해안','2024-09',1164311),
            ('조천해안','2024-10',1153969),('조천해안','2024-11',1078825),('조천해안','2024-12',957819),
            ('조천해안','2025-01',1059200),('조천해안','2025-02',869894),('조천해안','2025-03',947760),
            ('조천해안','2025-04',1064042),('조천해안','2025-05',1232614),('조천해안','2025-06',1227062),
            ('조천해안','2025-07',1428168),('조천해안','2025-08',1623406),('조천해안','2025-09',1159237),
            ('조천해안','2025-10',1441604),
            # 예래해안
            ('예래해안','2024-01',657725),('예래해안','2024-02',628532),('예래해안','2024-03',502923),
            ('예래해안','2024-04',649005),('예래해안','2024-05',700240),('예래해안','2024-06',661770),
            ('예래해안','2024-07',699022),('예래해안','2024-08',849833),('예래해안','2024-09',609977),
            ('예래해안','2024-10',674418),('예래해안','2024-11',554326),('예래해안','2024-12',554765),
            ('예래해안','2025-01',577445),('예래해안','2025-02',474121),('예래해안','2025-03',443778),
            ('예래해안','2025-04',526673),('예래해안','2025-05',617738),('예래해안','2025-06',637073),
            ('예래해안','2025-07',671114),('예래해안','2025-08',780801),('예래해안','2025-09',564291),
            ('예래해안','2025-10',743592),
            # 남원해안
            ('남원해안','2024-01',610377),('남원해안','2024-02',448776),('남원해안','2024-03',370163),
            ('남원해안','2024-04',421629),('남원해안','2024-05',435406),('남원해안','2024-06',413473),
            ('남원해안','2024-07',401330),('남원해안','2024-08',471870),('남원해안','2024-09',0),
            ('남원해안','2024-10',0),('남원해안','2024-11',343790),('남원해안','2024-12',424791),
            ('남원해안','2025-01',553909),('남원해안','2025-02',329542),('남원해안','2025-03',0),
            ('남원해안','2025-04',0),('남원해안','2025-05',0),('남원해안','2025-06',0),
            ('남원해안','2025-07',0),('남원해안','2025-08',0),('남원해안','2025-09',0),
            ('남원해안','2025-10',492364),
            # 성산해안
            ('성산해안','2024-01',495320),('성산해안','2024-02',450953),('성산해안','2024-03',507796),
            ('성산해안','2024-04',528999),('성산해안','2024-05',574719),('성산해안','2024-06',525905),
            ('성산해안','2024-07',500602),('성산해안','2024-08',553638),('성산해안','2024-09',514405),
            ('성산해안','2024-10',529468),('성산해안','2024-11',437578),('성산해안','2024-12',415027),
            ('성산해안','2025-01',446954),('성산해안','2025-02',357151),('성산해안','2025-03',387749),
            ('성산해안','2025-04',554018),('성산해안','2025-05',640180),('성산해안','2025-06',535792),
            ('성산해안','2025-07',560267),('성산해안','2025-08',660243),('성산해안','2025-09',518479),
            ('성산해안','2025-10',740973),
            # 한림해안
            ('한림해안','2024-01',415211),('한림해안','2024-02',393466),('한림해안','2024-03',423380),
            ('한림해안','2024-04',484591),('한림해안','2024-05',520474),('한림해안','2024-06',491377),
            ('한림해안','2024-07',565394),('한림해안','2024-08',688502),('한림해안','2024-09',456003),
            ('한림해안','2024-10',447196),('한림해안','2024-11',351883),('한림해안','2024-12',317964),
            ('한림해안','2025-01',318649),('한림해안','2025-02',0),('한림해안','2025-03',302506),
            ('한림해안','2025-04',406774),('한림해안','2025-05',493545),('한림해안','2025-06',501343),
            ('한림해안','2025-07',642890),('한림해안','2025-08',748836),('한림해안','2025-09',507266),
            ('한림해안','2025-10',572516),
            # 표선해안
            ('표선해안','2024-01',403931),('표선해안','2024-02',352887),('표선해안','2024-03',422259),
            ('표선해안','2024-04',440681),('표선해안','2024-05',0),('표선해안','2024-06',475753),
            ('표선해안','2024-07',496081),('표선해안','2024-08',573889),('표선해안','2024-09',442784),
            ('표선해안','2024-10',479933),('표선해안','2024-11',450126),('표선해안','2024-12',400373),
            ('표선해안','2025-01',396213),('표선해안','2025-02',358162),('표선해안','2025-03',403445),
            ('표선해안','2025-04',448400),('표선해안','2025-05',476834),('표선해안','2025-06',492684),
            ('표선해안','2025-07',522982),('표선해안','2025-08',576071),('표선해안','2025-09',429113),
            ('표선해안','2025-10',599058),
            # 중문해안
            ('중문해안','2024-01',378919),('중문해안','2024-02',342796),('중문해안','2024-03',0),
            ('중문해안','2024-04',448133),('중문해안','2024-05',488233),('중문해안','2024-06',428492),
            ('중문해안','2024-07',428755),('중문해안','2024-08',505447),('중문해안','2024-09',380044),
            ('중문해안','2024-10',478275),('중문해안','2024-11',365868),('중문해안','2024-12',295550),
            ('중문해안','2025-01',0),('중문해안','2025-02',285654),('중문해안','2025-03',296212),
            ('중문해안','2025-04',408910),('중문해안','2025-05',463442),('중문해안','2025-06',430765),
            ('중문해안','2025-07',441324),('중문해안','2025-08',512750),('중문해안','2025-09',384106),
            ('중문해안','2025-10',553002),
            # 구좌해안
            ('구좌해안','2024-01',0),('구좌해안','2024-02',0),('구좌해안','2024-03',344421),
            ('구좌해안','2024-04',0),('구좌해안','2024-05',0),('구좌해안','2024-06',450913),
            ('구좌해안','2024-07',515878),('구좌해안','2024-08',664575),('구좌해안','2024-09',416424),
            ('구좌해안','2024-10',0),('구좌해안','2024-11',0),('구좌해안','2024-12',0),
            ('구좌해안','2025-01',0),('구좌해안','2025-02',0),('구좌해안','2025-03',0),
            ('구좌해안','2025-04',394638),('구좌해안','2025-05',480801),('구좌해안','2025-06',503558),
            ('구좌해안','2025-07',654161),('구좌해안','2025-08',762264),('구좌해안','2025-09',455047),
            ('구좌해안','2025-10',513333),
            # 대정해안
            ('대정해안','2024-01',0),('대정해안','2024-02',0),('대정해안','2024-03',0),
            ('대정해안','2024-04',0),('대정해안','2024-05',0),('대정해안','2024-06',0),
            ('대정해안','2024-07',0),('대정해안','2024-08',0),('대정해안','2024-09',0),
            ('대정해안','2024-10',0),('대정해안','2024-11',0),('대정해안','2024-12',0),
            ('대정해안','2025-01',0),('대정해안','2025-02',0),('대정해안','2025-03',0),
            ('대정해안','2025-04',389437),('대정해안','2025-05',0),('대정해안','2025-06',0),
            ('대정해안','2025-07',0),('대정해안','2025-08',0),('대정해안','2025-09',0),
            ('대정해안','2025-10',0),
        ]
        
        existing_stats = db.query(CoastalVisitorStats).count()
        if existing_stats == 0:
            print("해안 방문객 통계 데이터 생성 중...")
            for region, year_month, visitor in coastal_stats_data:
                stat = CoastalVisitorStats(
                    region=region,
                    year_month=year_month,
                    visitor=visitor
                )
                db.add(stat)
            db.commit()
            print(f"{len(coastal_stats_data)}개 통계 데이터 생성 완료!")
        else:
            print(f"통계 데이터가 이미 존재합니다. (총 {existing_stats}개)")
            
    except Exception as e:
        print(f"오류 발생: {e}")
        print(f"오류 타입: {type(e).__name__}")
        db.rollback()
        sys.exit(1)
    finally:
        db.close()


if __name__ == "__main__":
    create_initial_users()
